name: Release Desktop App

permissions:
  contents: write

on:
  push:
    tags:
      - "desktop-v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 0.1.0)"
        required: false
        default: "0.0.0-dev"

env:
  CARGO_TERM_COLOR: always
  APP_NAME: Aumate
  APP_ID: com.tegojs.aumate

jobs:
  # ===========================================
  # macOS Builds
  # ===========================================
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
        include:
          - arch: x86_64
            target: x86_64-apple-darwin
          - arch: aarch64
            target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-desktop-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-desktop-

      - name: Build release binary
        run: cargo build --release --package aumate --target ${{ matrix.target }}

      - name: Create .app bundle
        run: |
          APP_DIR="${{ env.APP_NAME }}.app"
          mkdir -p "$APP_DIR/Contents/MacOS"
          mkdir -p "$APP_DIR/Contents/Resources"

          # Copy binary
          cp "target/${{ matrix.target }}/release/aumate" "$APP_DIR/Contents/MacOS/${{ env.APP_NAME }}"

          # Copy icon
          cp "packages/aumate/assets/icon.icns" "$APP_DIR/Contents/Resources/AppIcon.icns"

          # Get version from tag or input
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/desktop-v}"
          else
            VERSION="${{ github.event.inputs.version || '0.0.0-dev' }}"
          fi

          # Create Info.plist
          cat > "$APP_DIR/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>${{ env.APP_NAME }}</string>
              <key>CFBundleDisplayName</key>
              <string>${{ env.APP_NAME }}</string>
              <key>CFBundleIdentifier</key>
              <string>${{ env.APP_ID }}</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleExecutable</key>
              <string>${{ env.APP_NAME }}</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.13</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticGraphicsSwitching</key>
              <true/>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.developer-tools</string>
          </dict>
          </plist>
          EOF

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          create-dmg \
            --volname "${{ env.APP_NAME }}" \
            --volicon "packages/aumate/assets/icon.icns" \
            --background "packages/aumate/assets/dmg-background.png" \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 100 \
            --icon "${{ env.APP_NAME }}.app" 165 200 \
            --hide-extension "${{ env.APP_NAME }}.app" \
            --app-drop-link 495 200 \
            "${{ env.APP_NAME }}-${{ matrix.arch }}-macos.dmg" \
            "${{ env.APP_NAME }}.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: ${{ env.APP_NAME }}-${{ matrix.arch }}-macos.dmg
          if-no-files-found: error

  # ===========================================
  # Windows Builds
  # ===========================================
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, x86, arm64]
        include:
          - arch: x64
            target: x86_64-pc-windows-msvc
          - arch: x86
            target: i686-pc-windows-msvc
          - arch: arm64
            target: aarch64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-desktop-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-desktop-

      - name: Build release binary
        run: cargo build --release --package aumate --target ${{ matrix.target }}

      - name: Prepare release directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "release"
          Copy-Item "target/${{ matrix.target }}/release/aumate.exe" "release/${{ env.APP_NAME }}.exe"
          Copy-Item "packages/aumate/assets/icon.ico" "release/"
          if (Test-Path "packages/aumate/README.md") {
            Copy-Item "packages/aumate/README.md" "release/"
          }

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive -Path "release/*" -DestinationPath "${{ env.APP_NAME }}-${{ matrix.arch }}-windows.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: ${{ env.APP_NAME }}-${{ matrix.arch }}-windows.zip
          if-no-files-found: error

  # ===========================================
  # Linux Build (x86_64 only)
  # ===========================================
  build-linux:
    name: Build Linux (x86_64)
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libwayland-dev \
            libxcb1-dev \
            libxrandr-dev \
            libdbus-1-dev \
            libpipewire-0.3-dev \
            libegl1-mesa-dev \
            libgles2-mesa-dev \
            libgbm-dev \
            libasound2-dev \
            libxi-dev \
            libxtst-dev \
            libxdo-dev \
            libfuse2

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-x86_64-cargo-desktop-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-x86_64-cargo-desktop-

      - name: Build release binary
        run: cargo build --release --package aumate

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy binary
          cp target/release/aumate AppDir/usr/bin/${{ env.APP_NAME }}
          chmod +x AppDir/usr/bin/${{ env.APP_NAME }}

          # Copy icon
          cp packages/aumate/assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png
          cp packages/aumate/assets/icon.png AppDir/${{ env.APP_NAME }}.png

          # Copy desktop file
          cp packages/aumate/assets/aumate.desktop AppDir/usr/share/applications/
          cp packages/aumate/assets/aumate.desktop AppDir/

          # Create AppRun
          cat > AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/Aumate" "$@"
          APPRUN
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir ${{ env.APP_NAME }}-x86_64-linux.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: ${{ env.APP_NAME }}-x86_64-linux.AppImage
          if-no-files-found: error

  # ===========================================
  # Create GitHub Release
  # ===========================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-macos, build-windows, build-linux]

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -laR artifacts/

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/desktop-v}"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${{ github.event.inputs.version || '0.0.0-dev' }}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # macOS
          cp artifacts/macos-x86_64/*.dmg release-assets/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-macos-x64.dmg
          cp artifacts/macos-aarch64/*.dmg release-assets/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-macos-arm64.dmg

          # Windows
          cp artifacts/windows-x64/*.zip release-assets/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-windows-x64.zip
          cp artifacts/windows-x86/*.zip release-assets/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-windows-x86.zip
          cp artifacts/windows-arm64/*.zip release-assets/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-windows-arm64.zip

          # Linux
          cp artifacts/linux-x86_64/*.AppImage release-assets/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-linux-x64.AppImage

          echo "Release assets:"
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Aumate Desktop v${{ steps.version.outputs.VERSION }}
          body: |
            ## Aumate Desktop v${{ steps.version.outputs.VERSION }}

            Cross-platform desktop automation application with GUI support.

            ### Downloads

            | Platform | Architecture | Download |
            |----------|-------------|----------|
            | macOS | Intel (x64) | `${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-macos-x64.dmg` |
            | macOS | Apple Silicon (arm64) | `${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-macos-arm64.dmg` |
            | Windows | x64 | `${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-windows-x64.zip` |
            | Windows | x86 (32-bit) | `${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-windows-x86.zip` |
            | Windows | ARM64 | `${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-windows-arm64.zip` |
            | Linux | x64 | `${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-linux-x64.AppImage` |

            ### Installation

            **macOS:**
            1. Download the DMG for your architecture
            2. Open the DMG and drag Aumate to Applications
            3. First launch: Right-click > Open (to bypass Gatekeeper)

            **Windows:**
            1. Download the ZIP for your architecture
            2. Extract to a folder
            3. Run `Aumate.exe`

            **Linux:**
            1. Download the AppImage
            2. Make it executable: `chmod +x Aumate-*.AppImage`
            3. Run: `./Aumate-*.AppImage`

            ### System Requirements

            - **macOS**: 10.13 (High Sierra) or later
            - **Windows**: Windows 10 or later
            - **Linux**: glibc 2.31+ (Ubuntu 20.04+, Fedora 32+, etc.)

            ### What's Changed

            See the [CHANGELOG](https://github.com/tegojs/bot/blob/main/CHANGELOG.md) for details.
          files: release-assets/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
