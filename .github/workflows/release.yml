name: Release

permissions:
  contents: write
  packages: write

on:
  push:
    tags:
      - "v*.*.*"      # NPM releases: v0.1.0, v1.0.0, etc.
      - "[0-9]*.*.*"  # NPM releases: 0.1.0, 1.0.0, etc.
  workflow_dispatch:

jobs:
  build-napi:
    name: Build NAPI - ${{ matrix.settings.target }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: x86_64-apple-darwin
          - host: macos-latest
            target: aarch64-apple-darwin
          - host: windows-latest
            target: x86_64-pc-windows-msvc
          - host: windows-latest
            target: i686-pc-windows-msvc
          - host: windows-latest
            target: aarch64-pc-windows-msvc
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_native: true
    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.settings.target }}
          components: clippy, rustfmt

      - name: Install build dependencies (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            musl-tools \
            clang \
            pkg-config \
            libssl-dev \
            libglib2.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libwayland-dev \
            libxcb1-dev \
            libxrandr-dev \
            libdbus-1-dev \
            libpipewire-0.3-dev \
            libegl1-mesa-dev \
            libgles2-mesa-dev \
            libgbm-dev \
            libxi-dev \
            libxtst-dev \
            libc6-dev \
            linux-libc-dev

      - name: Install dependencies
        run: pnpm install -r

      - name: Build NAPI binary
        run: |
          cd packages/bot
          pnpm napi build --release --esm --const-enum --output-dir dist --platform --target ${{ matrix.settings.target }}
        shell: bash

      - name: List built files
        run: ls -la packages/bot/dist/
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: bindings-${{ matrix.settings.target }}
          path: |
            packages/bot/dist/*.node
            packages/bot/dist/index.js
            packages/bot/dist/index.d.ts
          if-no-files-found: error

  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs:
      - build-napi

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install -r

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List all downloaded artifacts
        run: |
          echo "-- Downloaded artifacts structure --"
          ls -laR artifacts/

      - name: Create dist directory for bot
        run: mkdir -p packages/bot/dist

      - name: Move all .node binaries to bot dist
        run: |
          echo "-- Moving .node files --"
          for artifact_dir in artifacts/bindings-*; do
            if [ -d "$artifact_dir" ]; then
              target=$(basename "$artifact_dir" | sed 's/^bindings-//')
              echo "Processing target: $target"

              node_file=$(find "$artifact_dir" -name "*.node" -type f)
              if [ -n "$node_file" ]; then
                case "$target" in
                  x86_64-apple-darwin)
                    dest_name="bot.darwin-x64.node"
                    ;;
                  aarch64-apple-darwin)
                    dest_name="bot.darwin-arm64.node"
                    ;;
                  x86_64-pc-windows-msvc)
                    dest_name="bot.win32-x64-msvc.node"
                    ;;
                  i686-pc-windows-msvc)
                    dest_name="bot.win32-ia32-msvc.node"
                    ;;
                  aarch64-pc-windows-msvc)
                    dest_name="bot.win32-arm64-msvc.node"
                    ;;
                  x86_64-unknown-linux-gnu)
                    dest_name="bot.linux-x64-gnu.node"
                    ;;
                  *)
                    echo "Warning: Unknown target $target, using generic name"
                    dest_name="bot.$target.node"
                    ;;
                esac

                echo "  Copying: $node_file -> packages/bot/dist/$dest_name"
                cp -v "$node_file" "packages/bot/dist/$dest_name"
              else
                echo "  Warning: No .node file found in $artifact_dir"
              fi
            fi
          done
          echo "-- Final dist contents --"
          ls -la packages/bot/dist/

      - name: Copy NAPI index files from artifact
        run: |
          # Copy index.js and index.d.ts from x86_64-unknown-linux-gnu artifact
          # These files are the same for all platforms
          artifact_dir="artifacts/bindings-x86_64-unknown-linux-gnu"

          if [ ! -d "$artifact_dir" ]; then
            echo "Error: Artifact directory $artifact_dir not found"
            exit 1
          fi

          if [ ! -f "$artifact_dir/index.js" ]; then
            echo "Error: index.js not found in $artifact_dir"
            echo "Contents of $artifact_dir:"
            ls -la "$artifact_dir" || echo "Directory is empty or doesn't exist"
            exit 1
          fi

          if [ ! -f "$artifact_dir/index.d.ts" ]; then
            echo "Error: index.d.ts not found in $artifact_dir"
            echo "Contents of $artifact_dir:"
            ls -la "$artifact_dir" || echo "Directory is empty or doesn't exist"
            exit 1
          fi

          echo "Copying index files from $artifact_dir"
          cp -v "$artifact_dir/index.js" packages/bot/dist/
          cp -v "$artifact_dir/index.d.ts" packages/bot/dist/

          # Verify both files were copied successfully
          if [ ! -f packages/bot/dist/index.js ]; then
            echo "Error: Failed to copy index.js"
            exit 1
          fi
          if [ ! -f packages/bot/dist/index.d.ts ]; then
            echo "Error: Failed to copy index.d.ts"
            exit 1
          fi

          echo "âœ“ Both index.js and index.d.ts copied successfully"
          ls -lh packages/bot/dist/index.*
        shell: bash

      - name: Verify bot package structure
        run: |
          echo "-- Bot package dist/ contents --"
          ls -la packages/bot/dist/
          echo "-- Checking for required files --"
          test -f packages/bot/dist/index.js && echo "âœ“ index.js found" || echo "âœ— index.js missing"
          test -f packages/bot/dist/index.d.ts && echo "âœ“ index.d.ts found" || echo "âœ— index.d.ts missing"
          echo "-- .node files --"
          find packages/bot/dist/ -name "*.node" -exec basename {} \;

      - name: Build TypeScript packages
        run: pnpm ts:build

      - name: Publish @tego/bot
        run: pnpm publish --access public --no-git-checks
        working-directory: packages/bot
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @tego/botjs
        run: pnpm publish --access public --no-git-checks
        working-directory: packages/botjs
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @tego/bot-agent
        run: pnpm publish --access public --no-git-checks
        working-directory: packages/bot-agent
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: publish-npm

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## ðŸš€ Tego Bot v${{ steps.version.outputs.VERSION }}

            High-performance desktop automation library for Node.js, powered by Rust.

            ### Installation
            ```bash
            npm install @tego/botjs@${{ steps.version.outputs.VERSION }}
            # or
            pnpm add @tego/botjs@${{ steps.version.outputs.VERSION }}
            ```

            ### Packages
            - `@tego/bot@${{ steps.version.outputs.VERSION }}` - Rust core with N-API bindings
            - `@tego/botjs@${{ steps.version.outputs.VERSION }}` - TypeScript wrapper (recommended)
            - `@tego/bot-agent@${{ steps.version.outputs.VERSION }}` - AI-powered CLI tool

            ### What's Changed
            See the [CHANGELOG](https://github.com/tegojs/bot/blob/main/CHANGELOG.md) for details.

            ### Documentation
            - ðŸ“– [Full Documentation](https://tegojs.github.io/bot/)
            - ðŸ“š [API Reference](https://tegojs.github.io/bot/api/)
            - ðŸš€ [Getting Started](https://tegojs.github.io/bot/guide/getting-started)
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
